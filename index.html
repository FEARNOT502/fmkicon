<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>아이콘 메이커</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Noto Sans KR', sans-serif;
        }
        input[type=range] {
            -webkit-appearance: none; appearance: none;
            width: 100%; height: 8px; background: #d3d3d3;
            outline: none; opacity: 0.7; transition: opacity .2s; border-radius: 4px;
        }
        input[type=range]:hover { opacity: 1; }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none; appearance: none;
            width: 20px; height: 20px; background: #3b82f6;
            cursor: pointer; border-radius: 50%;
        }
        input[type=range]::-moz-range-thumb {
            width: 20px; height: 20px; background: #3b82f6;
            cursor: pointer; border-radius: 50%;
        }
        #preview-container.draggable { cursor: grab; }
        #preview-container.dragging { cursor: grabbing; }
        #notification { transition: opacity 0.5s, transform 0.5s; }
        
        /* 리사이즈 핸들 스타일 */
        .resize-handle {
            position: absolute;
            width: 14px;
            height: 14px;
            background-color: #3b82f6;
            border: 2px solid white;
            border-radius: 50%;
            box-shadow: 0 0 5px rgba(0,0,0,0.3);
            display: none; /* 이미지가 로드되면 보이도록 설정 */
        }
        .resize-handle.br {
            bottom: -7px;
            right: -7px;
            cursor: se-resize;
        }
    </style>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen py-10">

    <div class="bg-white p-6 sm:p-8 rounded-2xl shadow-xl w-full max-w-4xl mx-4">
        <div class="text-center mb-6">
            <h1 class="text-2xl sm:text-3xl font-bold text-gray-800">50x50 아이 만들기</h1>
            <p class="text-gray-500 mt-2">파일을 선택하거나, 이미지를 복사한 후 여기에 붙여넣으세요 (Ctrl+V).</p>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            <!-- 컨트롤 패널 -->
            <div class="flex flex-col space-y-5">
                <div>
                    <label for="image-upload" class="block text-sm font-medium text-gray-700 mb-2">1. 이미지 업로드</label>
                    <input type="file" id="image-upload" accept="image/*" class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100 cursor-pointer">
                </div>

                <!-- 이미지 조정 -->
                <div class="space-y-4 pt-4 border-t">
                    <h3 class="text-lg font-semibold text-gray-800">이미지 조정</h3>
                    <div>
                        <div class="flex justify-between items-center mb-1"><label for="brightness" class="text-sm font-medium text-gray-700">명도</label><span id="brightness-value" class="text-sm text-gray-600 bg-gray-200 px-2 py-1 rounded-md">100%</span></div>
                        <input type="range" id="brightness" min="0" max="200" value="100">
                    </div>
                    <div>
                        <div class="flex justify-between items-center mb-1"><label for="contrast" class="text-sm font-medium text-gray-700">대비</label><span id="contrast-value" class="text-sm text-gray-600 bg-gray-200 px-2 py-1 rounded-md">100%</span></div>
                        <input type="range" id="contrast" min="0" max="200" value="100">
                    </div>
                    <div>
                        <div class="flex justify-between items-center mb-1"><label for="saturation" class="text-sm font-medium text-gray-700">채도</label><span id="saturation-value" class="text-sm text-gray-600 bg-gray-200 px-2 py-1 rounded-md">100%</span></div>
                        <input type="range" id="saturation" min="0" max="200" value="100">
                    </div>
                </div>

                <!-- 프레임 조정 -->
                <div class="space-y-4 pt-4 border-t">
                    <h3 class="text-lg font-semibold text-gray-800">프레임 조정</h3>
                    <div>
                        <div class="flex justify-between items-center mb-1"><label for="zoom" class="text-sm font-medium text-gray-700">확대/축소</label><span id="zoom-value" class="text-sm text-gray-600 bg-gray-200 px-2 py-1 rounded-md">100%</span></div>
                        <input type="range" id="zoom" min="10" max="500" value="100">
                    </div>
                    <div>
                        <div class="flex justify-between items-center mb-1"><label for="border-radius" class="text-sm font-medium text-gray-700">모서리 곡률</label><span id="border-radius-value" class="text-sm text-gray-600 bg-gray-200 px-2 py-1 rounded-md">0px</span></div>
                        <input type="range" id="border-radius" min="0" max="25" value="0">
                    </div>
                </div>

                <div class="pt-4 border-t grid grid-cols-2 gap-4">
                     <button id="reset-button" class="w-full bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg transition-colors">초기화</button>
                     <button id="download-button" class="w-full bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg transition-colors">다운로드</button>
                </div>
            </div>

            <!-- 미리보기 영역 -->
            <div class="flex flex-col items-center justify-center bg-gray-200 rounded-lg p-4">
                <p class="text-sm text-gray-600 mb-4 text-center">이미지를 드래그하여 위치를, 핸들을 드래그하여 크기를 조절하세요.</p>
                <div class="relative w-[250px] h-[250px] bg-white shadow-inner overflow-hidden" id="preview-wrapper">
                    <div id="preview-container" class="absolute top-1/2 left-1/2" style="width: 50px; height: 50px; transform: translate(-50%, -50%) scale(5); overflow: hidden; background-color: #f0f0f0;">
                        <div id="image-wrapper" class="absolute top-1/2 left-1/2" style="transform: translate(-50%, -50%);">
                            <img id="preview-image" class="absolute top-1/2 left-1/2" style="pointer-events: none; transform: translate(-50%, -50%);">
                            <div class="resize-handle br"></div>
                        </div>
                    </div>
                </div>
                <div class="mt-6 text-center">
                    <p class="text-sm font-semibold text-gray-700 mb-2">실제 아이콘 미리보기 (50x50)</p>
                    <div id="actual-size-preview" class="w-[50px] h-[50px] mx-auto bg-gray-100 shadow-md rounded-sm overflow-hidden">
                         <canvas id="actual-size-canvas" width="50" height="50"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 알림 메시지 -->
    <div id="notification" class="fixed top-5 right-5 bg-red-500 text-white py-2 px-4 rounded-lg shadow-lg opacity-0 transform translate-y-2"></div>

    <script>
        // DOM 요소
        const imageUpload = document.getElementById('image-upload');
        const previewContainer = document.getElementById('preview-container');
        const imageWrapper = document.getElementById('image-wrapper');
        const previewImage = document.getElementById('preview-image');
        const actualSizeCanvas = document.getElementById('actual-size-canvas');
        const resizeHandle = document.querySelector('.resize-handle');
        const allSliders = document.querySelectorAll('input[type=range]');
        const resetButton = document.getElementById('reset-button');
        const downloadButton = document.getElementById('download-button');
        const notification = document.getElementById('notification');

        // 상태 관리
        let state = { brightness: 100, contrast: 100, saturation: 100, zoom: 100, borderRadius: 0, posX: 0, posY: 0 };
        let isDragging = false, isResizing = false;
        let startPos = { x: 0, y: 0 }, imageStartPos = { x: 0, y: 0 };
        let resizeStart = { x: 0, y: 0, zoom: 100 };

        // --- 핵심 기능 함수 ---

        function updateImage() {
            if (!previewImage.src) return;
            const filter = `brightness(${state.brightness}%) contrast(${state.contrast}%) saturate(${state.saturation}%)`;
            const transform = `translate(${state.posX}px, ${state.posY}px) scale(${state.zoom / 100})`;
            imageWrapper.style.transform = transform;
            previewImage.style.filter = filter;
            previewContainer.style.borderRadius = `${state.borderRadius}px`;
            updateActualSizePreview();
        }

        function updateValues() {
            document.getElementById('brightness-value').textContent = `${state.brightness}%`;
            document.getElementById('contrast-value').textContent = `${state.contrast}%`;
            document.getElementById('saturation-value').textContent = `${state.saturation}%`;
            document.getElementById('zoom-value').textContent = `${Math.round(state.zoom)}%`;
            document.getElementById('border-radius-value').textContent = `${state.borderRadius}px`;
            document.getElementById('zoom').value = state.zoom;
        }

        function resetAll() {
            state = { brightness: 100, contrast: 100, saturation: 100, zoom: 100, borderRadius: 0, posX: 0, posY: 0 };
            if (previewImage.src) {
                initializeImagePosition();
            }
            allSliders.forEach(slider => {
                const initialValue = slider.id === 'border-radius' ? 0 : 100;
                slider.value = initialValue;
            });
            updateValues();
            updateImage();
        }
        
        function initializeImagePosition() {
            const imageWidth = previewImage.naturalWidth;
            const imageHeight = previewImage.naturalHeight;
            const scale = Math.max(50 / imageWidth, 50 / imageHeight);
            
            imageWrapper.style.width = `${imageWidth}px`;
            imageWrapper.style.height = `${imageHeight}px`;
            previewImage.style.width = `${imageWidth}px`;
            previewImage.style.height = `${imageHeight}px`;

            state.zoom = scale * 100;
            state.posX = 0;
            state.posY = 0;
            
            updateValues();
            updateImage();
        }

        function generateFinalCanvas() {
            const canvas = document.createElement('canvas');
            canvas.width = 50;
            canvas.height = 50;
            const ctx = canvas.getContext('2d');
            if (!previewImage.src || !previewImage.complete || previewImage.naturalWidth === 0) {
                return canvas; // 빈 캔버스 반환
            }

            ctx.fillStyle = '#ffffff';
            ctx.fillRect(0, 0, 50, 50);
            ctx.filter = `brightness(${state.brightness}%) contrast(${state.contrast}%) saturate(${state.saturation}%)`;
            
            ctx.save();
            if (state.borderRadius > 0) {
                ctx.beginPath();
                ctx.roundRect(0, 0, 50, 50, [state.borderRadius]);
                ctx.clip();
            }
            
            // CSS transform을 Canvas에 적용
            const finalScale = state.zoom / 100;
            const imgWidth = previewImage.naturalWidth;
            const imgHeight = previewImage.naturalHeight;

            const finalWidth = imgWidth * finalScale;
            const finalHeight = imgHeight * finalScale;
            
            // (0,0)을 기준으로 변환
            const finalX = state.posX + (50 - finalWidth) / 2;
            const finalY = state.posY + (50 - finalHeight) / 2;
            
            ctx.drawImage(previewImage, finalX, finalY, finalWidth, finalHeight);
            ctx.restore();
            return canvas;
        }

        function updateActualSizePreview() {
            const finalCanvas = generateFinalCanvas();
            const ctx = actualSizeCanvas.getContext('2d');
            ctx.clearRect(0, 0, 50, 50);
            ctx.drawImage(finalCanvas, 0, 0);
        }

        function downloadImage() {
            if (!previewImage.src) {
                showNotification('이미지를 먼저 업로드해주세요.');
                return;
            }
            const canvas = generateFinalCanvas();
            const link = document.createElement('a');
            link.download = 'my-image-50x50.png';
            link.href = canvas.toDataURL('image/png');
            link.click();
        }
        
        function handleImageFile(file) {
            if (file && file.type.startsWith('image/')) {
                const reader = new FileReader();
                reader.onload = (event) => {
                    previewImage.src = event.target.result;
                    previewImage.onload = () => {
                        resetAll();
                        previewContainer.classList.add('draggable');
                        resizeHandle.style.display = 'block';
                    };
                };
                reader.readAsDataURL(file);
            } else {
                showNotification('이미지 파일이 아닙니다.');
            }
        }

        function showNotification(message) {
            notification.textContent = message;
            notification.classList.remove('opacity-0', 'translate-y-2');
            setTimeout(() => {
                notification.classList.add('opacity-0', 'translate-y-2');
            }, 2000);
        }

        // --- 이벤트 리스너 설정 ---

        // 파일 업로드
        imageUpload.addEventListener('change', (e) => handleImageFile(e.target.files[0]));
        
        // 붙여넣기
        window.addEventListener('paste', (e) => {
            handleImageFile(e.clipboardData.files[0]);
        });
        
        // 슬라이더
        allSliders.forEach(slider => {
            slider.addEventListener('input', (e) => {
                state[e.target.id.replace('-', '')] = e.target.value;
                updateValues();
                updateImage();
            });
        });

        // 버튼
        resetButton.addEventListener('click', resetAll);
        downloadButton.addEventListener('click', downloadImage);

        // 이미지 드래그
        previewContainer.addEventListener('mousedown', (e) => {
            if (!previewImage.src || e.target === resizeHandle) return;
            isDragging = true;
            previewContainer.classList.add('dragging');
            startPos = { x: e.clientX, y: e.clientY };
            imageStartPos = { x: state.posX, y: state.posY };
            e.preventDefault();
        });

        // 리사이즈 핸들 드래그
        resizeHandle.addEventListener('mousedown', (e) => {
            isResizing = true;
            resizeStart = { x: e.clientX, y: e.clientY, zoom: state.zoom };
            e.preventDefault();
            e.stopPropagation();
        });

        // 마우스 이동 (전역)
        window.addEventListener('mousemove', (e) => {
            if (isDragging) {
                const dx = (e.clientX - startPos.x) / 5; // 5배 확대된 미리보기 보정
                const dy = (e.clientY - startPos.y) / 5;
                state.posX = imageStartPos.x + dx;
                state.posY = imageStartPos.y + dy;
                updateImage();
            } else if (isResizing) {
                const dx = e.clientX - resizeStart.x;
                const dy = e.clientY - resizeStart.y;
                // 이동 거리에 비례하여 줌 조절 (민감도 조절)
                const distance = Math.sqrt(dx*dx + dy*dy);
                const direction = (e.clientX > resizeStart.x || e.clientY > resizeStart.y) ? 1 : -1;
                const zoomChange = distance * 0.5 * direction;
                let newZoom = parseFloat(resizeStart.zoom) + zoomChange;
                
                state.zoom = Math.max(10, Math.min(500, newZoom)); // 10% ~ 500% 제한
                updateValues();
                updateImage();
            }
        });

        // 마우스 업 (전역)
        window.addEventListener('mouseup', () => {
            isDragging = false;
            isResizing = false;
            previewContainer.classList.remove('dragging');
        });

        // 초기화
        updateValues();
    </script>
</body>
</html>
