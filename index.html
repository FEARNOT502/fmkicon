<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>간단한 이미지 편집기</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Noto Sans KR', sans-serif;
        }
        /* 커스텀 슬라이더 스타일 */
        input[type=range] {
            -webkit-appearance: none;
            appearance: none;
            width: 100%;
            height: 8px;
            background: #d3d3d3;
            outline: none;
            opacity: 0.7;
            transition: opacity .2s;
            border-radius: 4px;
        }
        input[type=range]:hover {
            opacity: 1;
        }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            background: #3b82f6;
            cursor: pointer;
            border-radius: 50%;
        }
        input[type=range]::-moz-range-thumb {
            width: 20px;
            height: 20px;
            background: #3b82f6;
            cursor: pointer;
            border-radius: 50%;
        }
        /* 미리보기 창의 커서 스타일 */
        #preview-container.draggable {
            cursor: grab;
        }
        #preview-container.dragging {
            cursor: grabbing;
        }
        /* 알림 메시지 스타일 */
        #notification {
            transition: opacity 0.5s, transform 0.5s;
        }
    </style>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen">

    <div class="bg-white p-6 sm:p-8 rounded-2xl shadow-xl w-full max-w-4xl mx-4">
        <div class="text-center mb-6">
            <h1 class="text-2xl sm:text-3xl font-bold text-gray-800">50x50 아이콘 편집기</h1>
            <p class="text-gray-500 mt-2">이미지를 올리고 원하는 대로 편집해 보세요.</p>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            <!-- 컨트롤 패널 -->
            <div class="flex flex-col space-y-5">
                <div>
                    <label for="image-upload" class="block text-sm font-medium text-gray-700 mb-2">1. 이미지 업로드</label>
                    <input type="file" id="image-upload" accept="image/*" class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100 cursor-pointer">
                </div>

                <!-- 이미지 조정 슬라이더 -->
                <div class="space-y-4 pt-4 border-t">
                    <h3 class="text-lg font-semibold text-gray-800">이미지 조정</h3>
                    <!-- 명도 -->
                    <div>
                        <div class="flex justify-between items-center mb-1">
                            <label for="brightness" class="text-sm font-medium text-gray-700">명도</label>
                            <span id="brightness-value" class="text-sm text-gray-600 bg-gray-200 px-2 py-1 rounded-md">100%</span>
                        </div>
                        <input type="range" id="brightness" min="0" max="200" value="100">
                    </div>
                    <!-- 대비 -->
                    <div>
                        <div class="flex justify-between items-center mb-1">
                            <label for="contrast" class="text-sm font-medium text-gray-700">대비</label>
                            <span id="contrast-value" class="text-sm text-gray-600 bg-gray-200 px-2 py-1 rounded-md">100%</span>
                        </div>
                        <input type="range" id="contrast" min="0" max="200" value="100">
                    </div>
                    <!-- 채도 -->
                    <div>
                        <div class="flex justify-between items-center mb-1">
                            <label for="saturation" class="text-sm font-medium text-gray-700">채도</label>
                            <span id="saturation-value" class="text-sm text-gray-600 bg-gray-200 px-2 py-1 rounded-md">100%</span>
                        </div>
                        <input type="range" id="saturation" min="0" max="200" value="100">
                    </div>
                </div>

                <!-- 프레임 조정 슬라이더 -->
                <div class="space-y-4 pt-4 border-t">
                    <h3 class="text-lg font-semibold text-gray-800">프레임 조정</h3>
                    <!-- 확대/축소 -->
                    <div>
                        <div class="flex justify-between items-center mb-1">
                            <label for="zoom" class="text-sm font-medium text-gray-700">확대/축소</label>
                            <span id="zoom-value" class="text-sm text-gray-600 bg-gray-200 px-2 py-1 rounded-md">100%</span>
                        </div>
                        <input type="range" id="zoom" min="10" max="500" value="100">
                    </div>
                    <!-- 모서리 곡률 -->
                    <div>
                        <div class="flex justify-between items-center mb-1">
                            <label for="border-radius" class="text-sm font-medium text-gray-700">모서리 곡률</label>
                            <span id="border-radius-value" class="text-sm text-gray-600 bg-gray-200 px-2 py-1 rounded-md">0px</span>
                        </div>
                        <input type="range" id="border-radius" min="0" max="25" value="0">
                    </div>
                </div>

                <div class="pt-4 border-t grid grid-cols-2 gap-4">
                     <button id="reset-button" class="w-full bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg transition-colors">초기화</button>
                     <button id="download-button" class="w-full bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg transition-colors">다운로드</button>
                </div>
            </div>

            <!-- 미리보기 영역 -->
            <div class="flex flex-col items-center justify-center bg-gray-200 rounded-lg p-4">
                <p class="text-sm text-gray-600 mb-4">아래 상자 안에서 이미지를 마우스로 드래그하여 위치를 조절하세요.</p>
                <div class="relative w-[250px] h-[250px] bg-white shadow-inner overflow-hidden" id="preview-wrapper">
                    <div id="preview-container" class="absolute top-1/2 left-1/2" style="width: 50px; height: 50px; transform: translate(-50%, -50%) scale(5); overflow: hidden; background-color: #f0f0f0;">
                        <img id="preview-image" class="absolute" style="pointer-events: none;">
                    </div>
                </div>
                 <p class="text-xs text-gray-500 mt-2">실제 크기: 50x50 픽셀</p>
            </div>
        </div>
    </div>

    <!-- 알림 메시지 -->
    <div id="notification" class="fixed top-5 right-5 bg-red-500 text-white py-2 px-4 rounded-lg shadow-lg opacity-0 transform translate-y-2">
        이미지를 먼저 업로드해주세요.
    </div>

    <script>
        // DOM 요소 가져오기
        const imageUpload = document.getElementById('image-upload');
        const previewContainer = document.getElementById('preview-container');
        const previewImage = document.getElementById('preview-image');
        
        const brightnessSlider = document.getElementById('brightness');
        const contrastSlider = document.getElementById('contrast');
        const saturationSlider = document.getElementById('saturation');
        const zoomSlider = document.getElementById('zoom');
        const borderRadiusSlider = document.getElementById('border-radius');

        const brightnessValue = document.getElementById('brightness-value');
        const contrastValue = document.getElementById('contrast-value');
        const saturationValue = document.getElementById('saturation-value');
        const zoomValue = document.getElementById('zoom-value');
        const borderRadiusValue = document.getElementById('border-radius-value');

        const resetButton = document.getElementById('reset-button');
        const downloadButton = document.getElementById('download-button');
        const previewWrapper = document.getElementById('preview-wrapper');
        const notification = document.getElementById('notification');

        // 상태 관리 객체
        let state = {
            brightness: 100,
            contrast: 100,
            saturation: 100,
            zoom: 100,
            borderRadius: 0,
            posX: 0,
            posY: 0,
        };

        let isDragging = false;
        let startPos = { x: 0, y: 0 };
        let imageStartPos = { x: 0, y: 0 };

        // 이미지 업데이트 함수
        function updateImage() {
            if (!previewImage.src) return;

            const filter = `brightness(${state.brightness}%) contrast(${state.contrast}%) saturate(${state.saturation}%)`;
            // CSS transform은 top/left 위치에서 추가로 이동함
            const transform = `translate(${state.posX}px, ${state.posY}px) scale(${state.zoom / 100})`;

            previewImage.style.filter = filter;
            previewImage.style.transform = transform;
            previewContainer.style.borderRadius = `${state.borderRadius}px`;
        }

        // 값 표시 업데이트 함수
        function updateValues() {
            brightnessValue.textContent = `${state.brightness}%`;
            contrastValue.textContent = `${state.contrast}%`;
            saturationValue.textContent = `${state.saturation}%`;
            zoomValue.textContent = `${Math.round(state.zoom)}%`;
            borderRadiusValue.textContent = `${state.borderRadius}px`;
        }
        
        // 슬라이더 값 설정 함수
        function setSliders() {
            brightnessSlider.value = state.brightness;
            contrastSlider.value = state.contrast;
            saturationSlider.value = state.saturation;
            zoomSlider.value = state.zoom;
            borderRadiusSlider.value = state.borderRadius;
        }

        // 초기화 함수
        function resetAll() {
            state = {
                brightness: 100,
                contrast: 100,
                saturation: 100,
                zoom: 100,
                borderRadius: 0,
                posX: 0,
                posY: 0,
            };
            
            if (previewImage.src) {
                initializeImagePosition();
            }
            
            setSliders();
            updateValues();
            updateImage();
        }
        
        // 이미지 위치 및 크기 초기화 함수
        function initializeImagePosition() {
            const containerWidth = 50;
            const containerHeight = 50;
            const imageWidth = previewImage.naturalWidth;
            const imageHeight = previewImage.naturalHeight;

            // 컨테이너에 꽉 차게 이미지 크기 조절 (cover 효과)
            const scale = Math.max(containerWidth / imageWidth, containerHeight / imageHeight);
            const newWidth = imageWidth * scale;
            const newHeight = imageHeight * scale;

            // 이미지 중앙 정렬
            previewImage.style.width = `${newWidth}px`;
            previewImage.style.height = `${newHeight}px`;
            previewImage.style.top = `${(containerHeight - newHeight) / 2}px`;
            previewImage.style.left = `${(containerWidth - newWidth) / 2}px`;
            
            // 상태 초기화
            state.zoom = 100;
            state.posX = 0;
            state.posY = 0;
            
            // UI 업데이트
            zoomSlider.value = state.zoom;
            updateValues();
            updateImage();
        }
        
        // 알림 메시지 표시 함수
        function showNotification(message) {
            notification.textContent = message;
            notification.classList.remove('opacity-0', 'translate-y-2');
            setTimeout(() => {
                notification.classList.add('opacity-0', 'translate-y-2');
            }, 2000);
        }

        // 다운로드 함수
        function downloadImage() {
            if (!previewImage.src) {
                showNotification('이미지를 먼저 업로드해주세요.');
                return;
            }

            const canvas = document.createElement('canvas');
            canvas.width = 50;
            canvas.height = 50;
            const ctx = canvas.getContext('2d');

            // 1. 배경을 흰색으로 채움 (투명 PNG 대비)
            ctx.fillStyle = '#ffffff';
            ctx.fillRect(0, 0, 50, 50);

            // 2. 필터 적용
            ctx.filter = `brightness(${state.brightness}%) contrast(${state.contrast}%) saturate(${state.saturation}%)`;
            
            ctx.save(); // 현재 상태 저장

            // 3. 모서리 둥글게 클리핑
            if (state.borderRadius > 0) {
                ctx.beginPath();
                // roundRect는 최신 브라우저에서 지원
                ctx.roundRect(0, 0, 50, 50, [state.borderRadius]);
                ctx.clip();
            }

            // 4. 이미지 그리기 (CSS 변환을 Canvas에 재현)
            // 이미지의 초기 스케일 및 위치 계산
            const initialScale = Math.max(50 / previewImage.naturalWidth, 50 / previewImage.naturalHeight);
            const initialWidth = previewImage.naturalWidth * initialScale;
            const initialHeight = previewImage.naturalHeight * initialScale;
            const initialX = (50 - initialWidth) / 2;
            const initialY = (50 - initialHeight) / 2;

            // 최종 스케일 계산
            const finalScale = state.zoom / 100;

            // CSS의 transform: scale()은 중앙을 기준으로 하므로 Canvas에서도 동일하게 구현
            const scaledX = 25 + finalScale * (initialX - 25);
            const scaledY = 25 + finalScale * (initialY - 25);
            
            const finalWidth = initialWidth * finalScale;
            const finalHeight = initialHeight * finalScale;

            // 최종 위치는 스케일링 후 위치에 사용자의 드래그(translate) 값을 더함
            const finalX = scaledX + state.posX;
            const finalY = scaledY + state.posY;

            ctx.drawImage(previewImage, finalX, finalY, finalWidth, finalHeight);
            
            ctx.restore(); // 클리핑 전 상태로 복원

            // 5. 다운로드 링크 생성 및 클릭
            const link = document.createElement('a');
            link.download = 'my-image-50x50.png';
            link.href = canvas.toDataURL('image/png');
            link.click();
        }

        // --- 이벤트 리스너 ---
        imageUpload.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (event) => {
                    previewImage.src = event.target.result;
                    previewImage.onload = () => {
                        resetAll(); // 새 이미지 로드 시 모든 설정 초기화
                        previewWrapper.querySelector('p').style.display = 'none'; // 안내 문구 숨기기
                        previewContainer.classList.add('draggable');
                    };
                };
                reader.readAsDataURL(file);
            }
        });

        brightnessSlider.addEventListener('input', (e) => { state.brightness = e.target.value; updateValues(); updateImage(); });
        contrastSlider.addEventListener('input', (e) => { state.contrast = e.target.value; updateValues(); updateImage(); });
        saturationSlider.addEventListener('input', (e) => { state.saturation = e.target.value; updateValues(); updateImage(); });
        zoomSlider.addEventListener('input', (e) => { state.zoom = e.target.value; updateValues(); updateImage(); });
        borderRadiusSlider.addEventListener('input', (e) => { state.borderRadius = e.target.value; updateValues(); updateImage(); });

        resetButton.addEventListener('click', resetAll);
        downloadButton.addEventListener('click', downloadImage);

        // 드래그하여 이미지 이동 로직
        previewContainer.addEventListener('mousedown', (e) => {
            if (!previewImage.src) return;
            isDragging = true;
            previewContainer.classList.add('dragging');
            startPos.x = e.clientX;
            startPos.y = e.clientY;
            imageStartPos.x = state.posX;
            imageStartPos.y = state.posY;
            e.preventDefault();
        });

        window.addEventListener('mousemove', (e) => {
            if (!isDragging) return;
            const dx = e.clientX - startPos.x;
            const dy = e.clientY - startPos.y;
            // 5배 확대된 미리보기이므로 이동량을 1/5로 줄여 실제 50x50 기준에 맞춤
            state.posX = imageStartPos.x + dx / 5;
            state.posY = imageStartPos.y + dy / 5;
            updateImage();
        });

        window.addEventListener('mouseup', () => {
            if (isDragging) {
                isDragging = false;
                previewContainer.classList.remove('dragging');
            }
        });

        // 초기 상태 설정
        updateValues();
    </script>

</body>
</html>
